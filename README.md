# spring-cloud-alibaba
Spring Cloud Alibabaå­¦ä¹ demoï¼ˆå¤ä¹ å·©å›ºï¼‰

å…³äºï¼š
 - SpringBootè‡ªåŠ¨é…ç½®ï¼ˆdruid,redisç­‰ï¼‰
 - mybatis-plusä½¿ç”¨ï¼ˆä»£ç è‡ªåŠ¨ç”Ÿæˆã€crudæ¥å£ï¼‰
 - restfulé£æ ¼apiç”¨æ³•
 - nacosæœåŠ¡æ³¨å†Œä¸å‘ç°
 - æœåŠ¡é—´feignè¿œç¨‹è°ƒç”¨ï¼ŒåŠè´Ÿè½½å‡è¡¡
 - å¾…æ›´æ–°Â·Â·Â·

[TOC]

# åŸºäºSpring Cloud Alibabaæ„å»ºä¸€ä¸ªå¾®æœåŠ¡

## å¾®æœåŠ¡æ–¹æ¡ˆç®€ä»‹

ç›®å‰å¸‚åœºä¸Šä¸»æµçš„å¾®æœåŠ¡æœ‰ä¸‰å¥—ï¼š

- ç¬¬ä¸€å¥—ï¼šSpring Boot + Spring Cloud Netflix
- ç¬¬äºŒå¥—ï¼šSpring Boot + Dubbo + Zookeeper
- ç¬¬ä¸‰å¥—ï¼šSpring Boot + Spring Cloud Alibaba

ç¬¬ä¸€å¥—æ–¹æ¡ˆæ˜¯ç›®å‰ä½¿ç”¨è¾ƒä¸ºå¹¿æ³›çš„ï¼Œä½†æ˜¯**2018 å¹´ 12 æœˆ 12 æ—¥ï¼ŒNetflix å®£å¸ƒ Spring Cloud Netflix ç³»åˆ—æŠ€æœ¯æ ˆè¿›å…¥ç»´æŠ¤æ¨¡å¼ï¼ˆä¸å†æ·»åŠ æ–°ç‰¹æ€§ï¼‰**ï¼Œè¿™æ„å‘³ç€è¯¥é¡¹ç›®ä¸å†æ‹¥æœ‰åŠŸèƒ½ä¸Šçš„æ›´æ–°ï¼Œäºæ˜¯å…¶ä¸­å¾ˆå¤šçš„æ¨¡å—å°±å‡ºç°äº†ç›¸åº”çš„æ›¿ä»£å“ï¼Œä¹Ÿè®¸åœ¨ä¸ä¹…çš„å°†æ¥ï¼Œæ•´ä¸ªå°±ä¼šè¢«æ·˜æ±°ã€‚

ç¬¬äºŒå¥—çš„ç‰¹ç‚¹æ˜¯é›†æˆäº†Apache Dubboè¿™ä¸ªé«˜æ€§èƒ½ã€è½»é‡çº§çš„Java RPCå¼€æºæ¡†æ¶ï¼Œç›¸ä¿¡Dubboç°åœ¨å·²ç»éå¸¸æµè¡Œï¼Œä½¿ç”¨è¿‡çš„äººåº”è¯¥éƒ½èƒ½æ„Ÿå—åˆ°ä»–çš„å¼ºå¤§ã€‚å…¶æ¬¡è¿™å¥—æ–¹æ¡ˆåè°ƒæ¡†æ¶é‡‡ç”¨çš„æ˜¯Zookeeperï¼Œè¿™åŒæ ·æ˜¯åœ¨åˆ†å¸ƒå¼é¢†åŸŸéå¸¸æµè¡Œçš„ä¸€ä¸ªå¼ºä¸€è‡´æ€§æ¡†æ¶ï¼Œè§£å†³äº†åˆ†å¸ƒå¼ç¯å¢ƒä¸­å¤æ‚çš„åè°ƒå’Œç®¡ç†æœåŠ¡ï¼Œè®©å¼€å‘äººå‘˜ä¸“æ³¨äºæ ¸å¿ƒåº”ç”¨ç¨‹åºé€»è¾‘ï¼Œè€Œä¸å¿…æ‹…å¿ƒåº”ç”¨ç¨‹åºçš„åˆ†å¸ƒå¼ç‰¹æ€§ã€‚

ç¬¬ä¸‰å¥—æ–¹æ¡ˆä¹Ÿæ˜¯æœ€å¹´è½»çš„ä¸€å¥—æ–¹æ¡ˆï¼Œ**2018 å¹´ 10 æœˆ 31 æ—¥çš„å‡Œæ™¨ï¼Œè¿™ä¸ªä¼Ÿå¤§çš„æ—¥å­é‡Œï¼ŒSpring Cloud Alibaba æ­£å¼å…¥é©»äº† Spring Cloud å®˜æ–¹å­µåŒ–å™¨ï¼Œå¹¶åœ¨ Maven ä¸­å¤®åº“å‘å¸ƒäº†ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼š** 

[Spring Cloud for Alibaba 0.2.0 released](https://spring.io/blog/2018/10/30/spring-cloud-for-alibaba-0-2-0-released)

å¦‚ä¸‹æ˜¯å®˜æ–¹çš„ä»‹ç»ï¼š

> Spring Cloud Alibaba è‡´åŠ›äºæä¾›å¾®æœåŠ¡å¼€å‘çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆã€‚æ­¤é¡¹ç›®åŒ…å«å¼€å‘åˆ†å¸ƒå¼åº”ç”¨å¾®æœåŠ¡çš„å¿…éœ€ç»„ä»¶ï¼Œæ–¹ä¾¿å¼€å‘è€…é€šè¿‡ Spring Cloud ç¼–ç¨‹æ¨¡å‹è½»æ¾ä½¿ç”¨è¿™äº›ç»„ä»¶æ¥å¼€å‘åˆ†å¸ƒå¼åº”ç”¨æœåŠ¡ã€‚
>
> ä¾æ‰˜ Spring Cloud Alibabaï¼Œæ‚¨åªéœ€è¦æ·»åŠ ä¸€äº›æ³¨è§£å’Œå°‘é‡é…ç½®ï¼Œå°±å¯ä»¥å°† Spring Cloud åº”ç”¨æ¥å…¥é˜¿é‡Œå¾®æœåŠ¡è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡é˜¿é‡Œä¸­é—´ä»¶æ¥è¿…é€Ÿæ­å»ºåˆ†å¸ƒå¼åº”ç”¨ç³»ç»Ÿã€‚

**åœ¨2019çš„8æœˆä»½ï¼ŒSpring Cloud Alibaba æ‰å‘å¸ƒäº†ä»–çš„ç¬¬ä¸€ä¸ªæ­£å¼ç‰ˆæœ¬**ï¼Œæ­£å¦‚ä»–æ‰€ä»‹ç»çš„é‚£æ ·ï¼Œè‡´åŠ›äºä¸€ç«™å¼è§£å†³æ–¹æ¡ˆï¼Œä½ åªéœ€è¦å‡ ä¸ªç®€å•çš„é…ç½®ï¼Œå°±å¯ä»¥è§£å†³å¾®æœåŠ¡ä¸­éœ€è¦è§£å†³çš„è¯¸å¤šé—®é¢˜ï¼šæœåŠ¡çš„æ³¨å†Œä¸å‘ç°ï¼ŒæœåŠ¡é—´é€šä¿¡ï¼Œè´Ÿè½½å‡è¡¡ï¼Œé™æµé™çº§ï¼ŒåŠ¨æ€é…ç½®ç­‰ã€‚

## Spring Cloud Alibaba

### æœåŠ¡æ³¨å†Œä¸å‘ç°

é˜¿é‡Œé‡‡ç”¨äº†å…¨æ–°çš„Nacosæ¥å®ç°æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œç›¸æ¯”äºä¼ ç»Ÿçš„Eurekaï¼Œæ›´åŠ ç®€å•æ˜“ç”¨ï¼ŒåŠŸèƒ½ä¹Ÿä¼¼ä¹æ›´åŠ å¼ºå¤§ï¼Œä½¿ç”¨ç®€å•ï¼Œç•Œé¢UIä¹Ÿååˆ†å‹å¥½ï¼Œè€ŒNacosçš„åˆ†å¸ƒå¼åè°ƒæ¶æ„æ”¾å¼ƒäº†Zookeeperï¼Œè‡³äºä¸ºä»€ä¹ˆæ”¾å¼ƒï¼Œè§£é‡Šå¦‚ä¸‹ï¼š

> ### CAP
>
> æœ‰ä¸ªæ€è€ƒï¼Œä» CAP è§’åº¦è€ƒè™‘ï¼ŒæœåŠ¡æ³¨å†Œä¸­å¿ƒæ˜¯ CP ç³»ç»Ÿè¿˜æ˜¯ AP ç³»ç»Ÿå‘¢ï¼Ÿ
>
> - æœåŠ¡æ³¨å†Œä¸­å¿ƒæ˜¯ä¸ºäº†æœåŠ¡é—´è°ƒç”¨æœåŠ¡çš„ï¼Œé‚£ä¹ˆç»å¯¹ä¸å…è®¸å› ä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒå‡ºç°äº†é—®é¢˜è€Œå¯¼è‡´æœåŠ¡é—´çš„è°ƒç”¨å‡ºé—®é¢˜
> - å‡å¦‚æœ‰ node1ï¼Œnode2ï¼Œnode3 é›†ç¾¤èŠ‚ç‚¹ã€‚ä¿å­˜ç€å¯ç”¨æœåŠ¡åˆ—è¡¨ ip1ï¼Œip2ï¼Œip3ï¼Œè¯•æƒ³å¦‚æœæ­¤æ—¶ä¸ä¸€è‡´ï¼Œæ¯”å¦‚ node1 åªä¿å­˜äº†ip1ï¼Œip2ï¼Œæ­¤æ—¶æœåŠ¡è¯»å– node1 çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¼šé€ æˆä»€ä¹ˆå½±å“ï¼Ÿ
>
> è°ƒç”¨ node1 çš„æœåŠ¡ï¼Œé¡¶å¤šå°±æ˜¯è´Ÿè½½å‡è¡¡æ—¶ä¸ä¼šæœ‰æµé‡æ‰“åˆ° ip3ï¼Œç„¶åç­‰ node1 åŒæ­¥å› ip3 åï¼Œåˆä¸€è‡´äº†ï¼Œè¿™å¯¹æœåŠ¡å…¶å®æ²¡ä»€ä¹ˆå¤ªå¤§å½±å“ã€‚æ‰€ä»¥ï¼Œæ¨æµ‹å‡ºæœåŠ¡æ³¨å†Œä¸­å¿ƒåº”è¯¥æ˜¯ä¸ª AP ç³»ç»Ÿã€‚
>
> ### Zookeeper æ˜¯ä¸ª CP ç³»ç»Ÿï¼Œå¼ºä¸€è‡´æ€§
>
> - åœºæ™¯1ï¼Œå½“ master æŒ‚äº†ï¼Œæ­¤æ—¶ Zookeeper é›†ç¾¤éœ€è¦é‡æ–°é€‰ä¸¾ï¼Œè€Œæ­¤æ—¶æœåŠ¡éœ€è¦æ¥è¯»å–å¯ç”¨æœåŠ¡ï¼Œæ˜¯ä¸å¯ç”¨çš„ã€‚å½±å“åˆ°äº†æœåŠ¡çš„å¯ç”¨æ€§å½“ç„¶ä½ å¯ä»¥è¯´æœåŠ¡æœ¬åœ°æœ‰ç¼“å­˜å¯ç”¨åˆ—è¡¨ã€‚ç„¶è€Œä¸‹é¢è¿™ç§æ–¹å¼å°±æ›´æ— æ³•å¤„ç†äº†ã€‚
> - åœºæ™¯2ï¼Œåˆ†åŒºå¯ç”¨ã€‚è¯•æƒ³ï¼Œæœ‰ 3 ä¸ªæœºæˆ¿ï¼Œå¦‚æœå…¶ä¸­æœºæˆ¿ 3 å’Œæœºæˆ¿ 1ï¼Œ2 ç½‘ç»œæ–­äº†ï¼Œé‚£ä¹ˆæœºæˆ¿ 3 çš„æ³¨å†Œä¸­å¿ƒå°±ä¸èƒ½æ³¨å†Œæ–°çš„æœºå™¨äº†ï¼Œè¿™æ˜¾ç„¶ä¹Ÿä¸åˆç†
>
> ![](https://mew.oss-cn-shanghai.aliyuncs.com/img2/da288a836eac2ddeeb0bbdfa0fd29fb4b8d.jpg)
>
> - ä»å¥åº·æ£€æŸ¥è§’åº¦æ¥çœ‹Zookeeper æ˜¯é€šè¿‡ TCP çš„å¿ƒè·³åˆ¤æ–­æœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œä½† TCP çš„æ´»æ€§å¹¶ä¸ä»£è¡¨æœåŠ¡æ˜¯å¯ç”¨çš„ï¼Œå¦‚ï¼šè¿æ¥æ± å·²æ»¡ï¼ŒDB æŒ‚äº†ç­‰
>
> ### ç†æƒ³çš„æ³¨å†Œä¸­å¿ƒ
>
> - æœåŠ¡è‡ªåŠ¨æ³¨å†Œå‘ç°ã€‚æœ€å¥½æœ‰æ–°çš„æœåŠ¡æ³¨å†Œä¸Šå»æ—¶è¿˜èƒ½æ¨é€åˆ°è°ƒç”¨ç«¯
> - èƒ½å¯¹æ³¨å†Œä¸Šæ¥çš„æœºå™¨æ–¹ä¾¿çš„è¿›è¡Œç®¡ç†ï¼Œèƒ½æ‰‹åŠ¨åˆ é™¤ï¼ˆå‘é€ä¿¡å·è®©æœåŠ¡ä¼˜é›…ä¸‹çº¿ï¼‰ã€æ¢å¤æœºå™¨
> - æœåŠ¡çš„å¥åº·æ£€æŸ¥ï¼Œèƒ½çœŸæ­£çš„æ£€æµ‹åˆ°æœåŠ¡æ˜¯å¦å¯ç”¨
> - å¯ä»¥çœ‹åˆ°æ˜¯å¦æœ‰å…¶ä»–è°ƒç”¨æœåŠ¡æ­£åœ¨è®¢é˜…æ³¨å†Œä¸Šæ¥çš„æœåŠ¡
> - èƒ½å¤Ÿå¸¦ä¸Šäº›é™¤äº† IP å¤–çš„å…¶å®ƒä¿¡æ¯

å…³äºNacosçš„ä½¿ç”¨æ–¹æ³•ï¼Œè¯·æˆ³[è¿™é‡Œ]()è·³è½¬,æ¨èä½¿ç”¨Dockeræ–¹å¼å®‰è£…ã€‚

### æœåŠ¡é—´é€šä¿¡

Spring Cloud Alibabaä»ç„¶æ”¯æŒå¯¹äºDubboçš„é›†æˆï¼Œå¯¹ä»£ç åŸºæœ¬æ— ä¾µå…¥ï¼ŒåŒæ—¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Feignè°ƒç”¨ï¼Œä»–åº•å±‚ä¸åŒäºDubboï¼Œå°è£…äº†Ribbonï¼Œå±äºhttpè°ƒç”¨ï¼ŒSpring Cloudè‡ªå¸¦ï¼Œä½¿ç”¨èµ·æ¥éå¸¸ä¾¿æ·ï¼š

```java
@FeignClient("service1")
public interface IGetUserService {
    @GetMapping("/get")
    List<User> feignGet();
}
```

è°ƒç”¨ä»¥ä¸Šæ¥å£å°±ç›¸å½“äºä»¥httpçš„æ–¹å¼è°ƒç”¨â€service1â€œæœåŠ¡çš„ "/get" ç«¯ç‚¹ã€‚åŒæ—¶ï¼Œå½“æœ‰å¤šä¸ªâ€œservice1â€å­˜åœ¨æ—¶ï¼ŒFeignè‡ªåŠ¨çš„å°±å®ç°äº†è´Ÿè½½å‡è¡¡ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨çš„æ˜¯è½®è¯¢è®¿é—®ç­–ç•¥ï¼Œå½“ç„¶è¿˜æœ‰å…¶ä»–ç­–ç•¥å¯ä»¥é€‰æ‹©ï¼Œç›´æ¥åœ¨yamlæ–‡ä»¶é‡Œé…ç½®å°±å¯ä»¥ç”Ÿæ•ˆï¼š

```yaml
# é…ç½®è´Ÿè½½å‡è¡¡ï¼Œé»˜é€šè¿‡ribbonå®ç°ï¼Œé»˜è®¤æ˜¯è½®è¯¢æ¨¡å¼
sca-provider-service: # å•ä¸ªæœåŠ¡å†™ä¸ŠæœåŠ¡å
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule # éšæœºè§„åˆ™
#   NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RoundRobinRule # è½®è¯¢(é»˜è®¤)
#   NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RetryRule # é‡è¯•
#   NFLoadBalancerRuleClassName: com.netflix.loadbalancer.WeightedResponseTimeRule # å“åº”æ—¶é—´æƒé‡
```

### æœåŠ¡ç†”æ–­é™çº§

ä¸ºä»€ä¹ˆè¦åšç†”æ–­é™çº§ï¼Œé¦–å…ˆäº†è§£â€œé›ªå´©â€æ•ˆåº”:

> åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæ ¹æ®ä¸šåŠ¡æ¥æ‹†åˆ†æˆä¸€ä¸ªä¸ªçš„æœåŠ¡ï¼ŒæœåŠ¡ä¸æœåŠ¡ä¹‹é—´å¯ä»¥é€šè¿‡ `RPC` ç›¸äº’è°ƒç”¨ï¼Œåœ¨ Spring Cloud ä¸­å¯ä»¥ç”¨ `RestTemplate + LoadBalanceClient` å’Œ `Feign` æ¥è°ƒç”¨ã€‚ä¸ºäº†ä¿è¯å…¶é«˜å¯ç”¨ï¼Œå•ä¸ªæœåŠ¡é€šå¸¸ä¼šé›†ç¾¤éƒ¨ç½²ã€‚ç”±äºç½‘ç»œåŸå› æˆ–è€…è‡ªèº«çš„åŸå› ï¼ŒæœåŠ¡å¹¶ä¸èƒ½ä¿è¯ 100% å¯ç”¨ï¼Œå¦‚æœå•ä¸ªæœåŠ¡å‡ºç°é—®é¢˜ï¼Œè°ƒç”¨è¿™ä¸ªæœåŠ¡å°±ä¼šå‡ºç°çº¿ç¨‹é˜»å¡ï¼Œæ­¤æ—¶è‹¥æœ‰å¤§é‡çš„è¯·æ±‚æ¶Œå…¥ï¼Œ`Servlet` å®¹å™¨çš„çº¿ç¨‹èµ„æºä¼šè¢«æ¶ˆè€—å®Œæ¯•ï¼Œå¯¼è‡´æœåŠ¡ç˜«ç—ªã€‚æœåŠ¡ä¸æœåŠ¡ä¹‹é—´çš„ä¾èµ–æ€§ï¼Œæ•…éšœä¼šä¼ æ’­ï¼Œä¼šå¯¹æ•´ä¸ªå¾®æœåŠ¡ç³»ç»Ÿé€ æˆç¾éš¾æ€§çš„ä¸¥é‡åæœï¼Œè¿™å°±æ˜¯æœåŠ¡æ•…éšœçš„ **â€œé›ªå´©â€** æ•ˆåº”ã€‚

é˜¿é‡Œä½¿ç”¨**[Sentinel](https://github.com/alibaba/Sentinel/wiki/ä»‹ç»)** (ğŸ‘ˆğŸ»ç‚¹å‡»è¿›å…¥ä¸­æ–‡æ–‡æ¡£)æ¥åšç†”æ–­é™çº§

### è·¯ç”±ç½‘å…³ç»Ÿä¸€è®¿é—®æ¥å£

æ­¤å¤„æ²¿ç”¨Spring Cloud Gateway

#### Spring Cloud Gateway åŠŸèƒ½ç‰¹å¾

> - åŸºäº Spring Framework 5ï¼ŒProject Reactor å’Œ Spring Boot 2.0
> - åŠ¨æ€è·¯ç”±
> - Predicates å’Œ Filters ä½œç”¨äºç‰¹å®šè·¯ç”±
> - é›†æˆ Hystrix æ–­è·¯å™¨
> - é›†æˆ Spring Cloud DiscoveryClient
> - æ˜“äºç¼–å†™çš„ Predicates å’Œ Filters
> - é™æµ
> - è·¯å¾„é‡å†™

#### Spring Cloud Gateway å·¥ç¨‹æµç¨‹

![](https://mew.oss-cn-shanghai.aliyuncs.com/img2/22e4eccf2cbe09332678c04b8de98ebe.jpg)

å®¢æˆ·ç«¯å‘ Spring Cloud Gateway å‘å‡ºè¯·æ±‚ã€‚ç„¶ååœ¨ Gateway Handler Mapping ä¸­æ‰¾åˆ°ä¸è¯·æ±‚ç›¸åŒ¹é…çš„è·¯ç”±ï¼Œå°†å…¶å‘é€åˆ° Gateway Web Handlerã€‚Handler å†é€šè¿‡æŒ‡å®šçš„è¿‡æ»¤å™¨é“¾æ¥å°†è¯·æ±‚å‘é€åˆ°æˆ‘ä»¬å®é™…çš„æœåŠ¡æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œç„¶åè¿”å›ã€‚

è¿‡æ»¤å™¨ä¹‹é—´ç”¨è™šçº¿åˆ†å¼€æ˜¯å› ä¸ºè¿‡æ»¤å™¨å¯èƒ½ä¼šåœ¨å‘é€ä»£ç†è¯·æ±‚ä¹‹å‰ï¼ˆ`pre`ï¼‰æˆ–ä¹‹åï¼ˆ`post`ï¼‰æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚

### é“¾è·¯è¿½è¸ª

- SkyWalking

### å¼‚æ­¥é€šä¿¡

- RocketMQ
- RibbitMQ
- Kafka

